# UI

Built with React and Vite.

## Directory Structure

```text
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ animations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Animations.tsx
‚îÇ   ‚îú‚îÄ‚îÄ knowledge-base/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ KnowledgeTable.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layouts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ArchonChatPanel.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MainLayout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SideNavigation.tsx
‚îÇ   ‚îú‚îÄ‚îÄ mcp/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ClientCard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MCPClients.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ToolTestingPanel.tsx
‚îÇ   ‚îú‚îÄ‚îÄ project-tasks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BlockNoteEditor.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DataTab.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DocsTab.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DraggableTaskCard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FeaturesTab.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Tabs.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TaskBoardView.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TaskTableView.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ VersionHistoryModal.tsx
‚îÇ   ‚îú‚îÄ‚îÄ settings/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ APIKeysSection.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FeaturesSection.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IDEGlobalRules.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RAGSettings.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TestStatus.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Badge.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Button.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Card.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Select.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ThemeToggle.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Toggle.tsx
‚îÇ   ‚îú‚îÄ‚îÄ CrawlingProgressCard.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ProjectCreationProgressCard.tsx
‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îú‚îÄ‚îÄ SettingsContext.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ThemeContext.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ToastContext.tsx
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useNeonGlow.ts
‚îÇ   ‚îî‚îÄ‚îÄ useStaggeredEntrance.ts
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ projectSchemas.ts
‚îÇ   ‚îú‚îÄ‚îÄ task-utils.tsx
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ KnowledgeBasePage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ MCPPage.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ProjectPage.tsx
‚îÇ   ‚îî‚îÄ‚îÄ SettingsPage.tsx
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ agentChatService.ts
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ crawlProgressService.ts
‚îÇ   ‚îú‚îÄ‚îÄ credentialsService.ts
‚îÇ   ‚îú‚îÄ‚îÄ knowledgeBaseService.ts
‚îÇ   ‚îú‚îÄ‚îÄ mcpClientService.ts
‚îÇ   ‚îú‚îÄ‚îÄ mcpServerService.ts
‚îÇ   ‚îú‚îÄ‚îÄ mcpService.ts
‚îÇ   ‚îú‚îÄ‚îÄ projectCreationProgressService.ts
‚îÇ   ‚îú‚îÄ‚îÄ projectService.ts
‚îÇ   ‚îú‚îÄ‚îÄ testService.ts
‚îÇ   ‚îî‚îÄ‚îÄ websocketService.ts
‚îî‚îÄ‚îÄ types/
    ‚îú‚îÄ‚îÄ knowledge.ts
    ‚îî‚îÄ‚îÄ project.ts
```

## Environment Variables

| Variable                  | Description                       |
|---------------------------|-----------------------------------|
| VITE_API_URL              | Backend API base URL              |
| VITE_API_BASE_URL         | Base URL used by some services    |

## Running Locally

```bash
cd archon-ui-main
npm install
npm run dev
```

## Component Communication

```mermaid
%%{init:{
  'theme':'base',
  'themeVariables': {
    'primaryColor':'#0a0a0a',
    'primaryTextColor':'#ffffff',
    'primaryBorderColor':'#6f55ff',
    'secondaryColor':'#111111',
    'secondaryBorderColor':'#3fb1ff',
    'tertiaryColor':'#1a1a1a',
    'tertiaryBorderColor':'#00d38a',
    'lineColor':'#3fb1ff',
    'textColor':'#ffffff',
    'fontFamily':'Inter',
    'fontSize':'14px',
    'background':'#0a0a0a',
    'mainBkg':'#111111',
    'secondBkg':'#1a1a1a',
    'clusterBkg':'rgba(17, 17, 17, 0.8)',
    'nodeTextColor':'#ffffff'
  }
}}%%
flowchart LR
  A["User"] --> B["React Form"]
  B --> C["API Call"]
  C --> D["Display Answer"]
```

See [Getting Started](getting-started) for details.

# Archon UI - Knowledge Engine Web Interface

A modern React-based web interface for the Archon Knowledge Engine MCP Server. Built with TypeScript, Vite, and Tailwind CSS.

## üé® UI Overview

Archon UI provides a comprehensive dashboard for managing your AI's knowledge base:

![UI Architecture](https://via.placeholder.com/800x400?text=Archon+UI+Architecture)

### Key Features

- **üìä MCP Dashboard**: Monitor and control the MCP server
- **‚öôÔ∏è Settings Management**: Configure credentials and RAG strategies
- **üìö Knowledge Management**: Browse, search, and organize knowledge items
- **üìà Real-time Updates**: WebSocket-based live updates across the UI

## üèóÔ∏è Architecture

### Technology Stack

- **React 18.3**: Modern React with hooks and functional components
- **TypeScript**: Full type safety and IntelliSense support
- **Vite**: Fast build tool and dev server
- **Tailwind CSS**: Utility-first styling
- **Framer Motion**: Smooth animations and transitions
- **Lucide Icons**: Beautiful and consistent iconography
- **React Router**: Client-side routing


## üìÑ Pages Documentation

### 1. Knowledge Base (`/`)

Browse and manage your knowledge items with multiple view modes.

**Components:**
- **Knowledge Grid**: Card-based knowledge display with domain grouping
- **Knowledge Table**: Full-width table view with sortable columns
- **Search/Filter**: Search by title, type, tags
- **Crawling Progress**: Real-time progress tracking for URL crawling
- **Actions**: Delete, add sources, file upload

**Features:**
- Grid and table view modes
- Real-time updates via WebSocket
- Type-based filtering (technical/business)
- Domain-based grouping for URLs
- Tag tooltips for overflow
- Progress tracking for crawling operations

### 2. Projects (`/projects`)

Project dashboard with task management and documentation tabs.

**Components:**
- **Project List**: Create and select projects
- **Task Tabs**: Manage tasks, features, docs and data
- **Progress Cards**: Real-time project creation status

**Features:**
- Hierarchical tasks
- GitHub repository links
- WebSocket project progress

### 3. Settings (`/settings`)

Comprehensive configuration management with organized sections.

**Sections:**
- **Features**: 
  - Projects toggle (enable/disable Projects feature)
  - Other feature flags
- **API Keys**: 
  - OpenAI API key (encrypted storage)
  - Other API credentials
- **RAG Settings**:
  - Contextual Embeddings toggle
  - Hybrid Search toggle
  - Agentic RAG (code extraction) toggle
  - Reranking toggle
  - Model selection
- **Archon Unit Tests** (Collapsible):
  - Python MCP tests with real-time output
  - React UI tests with local execution
  - Pretty/Raw view modes
  - Error summary display

**Features:**
- Secure credential storage with encryption
- Real-time test execution and monitoring
- Toast notifications for actions
- Collapsible test section (collapsed by default)

### 4. MCP Dashboard (`/mcp`)

Central control panel for the MCP server.

**Components:**
- **Server Control Panel**: Start/stop server, view status, select transport mode
- **Server Logs Viewer**: Real-time log streaming with auto-scroll
- **Available Tools Table**: Dynamic tool discovery and documentation
- **MCP Test Panel**: Interactive tool testing interface

**Features:**
- Dual transport support (SSE/stdio)
- Real-time status polling (5-second intervals)
- WebSocket-based log streaming
- Copy-to-clipboard configuration
- Tool parameter validation

Browse and manage your knowledge items.

**Components:**
- **Knowledge Grid**: Card-based knowledge display
- **Search/Filter**: Search by title, type, tags
- **Knowledge Details**: View full item details
- **Actions**: Delete, refresh, organize

**Features:**
- Pagination support
- Real-time updates via WebSocket
- Type-based filtering (technical/business)
- Metadata display


## üß© Component Library

### Base UI Components

#### Button
```tsx
<Button 
  variant="primary|secondary|ghost" 
  size="sm|md|lg"
  accentColor="blue|green|purple|orange|pink"
  onClick={handleClick}
>
  Click me
</Button>
```

#### Card
```tsx
<Card accentColor="blue" className="p-6">
  <h3>Card Title</h3>
  <p>Card content</p>
</Card>
```

#### LoadingSpinner
```tsx
<LoadingSpinner size="sm|md|lg" />
```

### Layout Components

#### Sidebar
- Collapsible navigation
- Active route highlighting
- Icon + text navigation items
- Responsive design

#### Header
- Dark mode toggle
- User menu
- Breadcrumb navigation

### Animation Components

#### PageTransition
Wraps pages with smooth fade/slide animations:
```tsx
<PageTransition>
  <YourPageContent />
</PageTransition>
```

## üîå Services

### mcpService
Handles all MCP server communication:
- `startServer()`: Start the MCP server
- `stopServer()`: Stop the MCP server
- `getStatus()`: Get current server status
- `streamLogs()`: WebSocket log streaming
- `getAvailableTools()`: Fetch MCP tools

### api
Base API configuration with:
- Automatic error handling
- Request/response interceptors
- Base URL configuration
- TypeScript generics

### chatService
RAG query interface:
- `sendMessage()`: Send RAG query
- `streamResponse()`: Stream responses
- `getSources()`: Get available sources

## üé® Styling

### Tailwind Configuration
- Custom color palette
- Dark mode support
- Custom animations
- Responsive breakpoints

### Theme Variables
```css
--primary: Blue accent colors
--secondary: Gray/neutral colors
--success: Green indicators
--warning: Orange indicators
--error: Red indicators
```

## üöÄ Development

### Setup
```bash
# Install dependencies
npm install

# Start dev server
npm run dev

# Build for production
npm run build

# Run tests
npm test
```

### Environment Variables
```env
VITE_API_URL=http://localhost:8080
VITE_API_BASE_URL=http://localhost:8080
```

### Hot Module Replacement
Vite provides instant HMR for:
- React components
- CSS modules
- TypeScript files

## üß™ Testing

### Unit Tests
- Component testing with React Testing Library
- Service mocking with MSW
- Hook testing with @testing-library/react-hooks

### Integration Tests
- Page-level testing
- API integration tests
- WebSocket testing

## üì¶ Build & Deployment

### Docker Support
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build
EXPOSE 5173
CMD ["npm", "run", "preview"]
```

### Production Optimization
- Code splitting by route
- Lazy loading for pages
- Image optimization
- Bundle size analysis

## üîß Configuration Files

### vite.config.ts
- Path aliases
- Build optimization
- Development server config

### tsconfig.json
- Strict type checking
- Path mappings
- Compiler options

### tailwind.config.js
- Custom theme
- Plugin configuration
- Purge settings

## ‚úÖ Frontend Development Standards

### üö® **CRITICAL: Toast and State Management**

Based on systematic debugging of duplicate toasts and WebSocket instability across the app, follow these patterns:

#### **Duplicate Toast Prevention**

**Root Cause**: Multiple event sources (WebSocket + Progress callbacks + API responses) all showing the same toast.

**Solution**: Single source of truth for events.

```typescript
// ‚ùå PROBLEMATIC: Multiple event sources showing the same toast
const handleProgressComplete = (data: CrawlProgressData) => {
  console.log('Crawl completed:', data);
  setProgressItems(prev => prev.filter(item => item.progressId !== data.progressId));
  loadKnowledgeItems();
  showToast('Crawling completed successfully', 'success'); // ‚ùå Also called by WebSocket!
};

// WebSocket handler ALSO calls:
if (data.type === 'crawl_completed') {
  showToast('Crawling completed successfully', 'success'); // ‚ùå Duplicate!
}

// ‚úÖ FIXED: Single source of truth
const handleProgressComplete = (data: CrawlProgressData) => {
  console.log('Crawl completed:', data);
  setProgressItems(prev => prev.filter(item => item.progressId !== data.progressId));
  loadKnowledgeItems();
  // Toast will be shown by WebSocket completion event to avoid duplicates
};

// Only WebSocket handler shows the toast:
if (data.type === 'crawl_completed') {
  showToast('Crawling completed successfully', 'success'); // ‚úÖ Single source!
}
```

#### **useEffect Dependency Management**

**THE #1 CAUSE OF DOUBLE EXECUTION**: Including state variables that change during the effect execution in dependency arrays.

```typescript
// ‚ùå PROBLEMATIC: backendReady changes during effect execution
useEffect(() => {
  const checkOpenAIKey = async () => {
    if (hasShownApiKeyToast) return;
    
    // This sets backendReady to true, triggering the effect again!
    setBackendReady(true);
    checkCredentials();
  };
  
  checkOpenAIKey();
}, [showToast, navigate, hasShownApiKeyToast, backendReady]); // ‚ùå backendReady causes double run

// ‚úÖ FIXED: Remove state variables that are set inside the effect
useEffect(() => {
  const checkOpenAIKey = async () => {
    if (hasShownApiKeyToast) return;
    
    // Use local variable instead of state dependency
    let isBackendReady = false;
    
    if (response.ok) {
      console.log('‚úÖ Backend is ready, checking credentials...');
      isBackendReady = true;
      setBackendReady(true); // Still set state, just don't depend on it
      // Continue with credential check...
    }
  };
  
  checkOpenAIKey();
}, [showToast, navigate, hasShownApiKeyToast]); // ‚úÖ No internal state dependencies
```

#### **Standard Patterns**

**For Event Completion**: Choose ONE source of truth for showing success/completion toasts:
- **WebSocket events**: Preferred for real-time operations (crawling, task updates)
- **API responses**: For direct user actions (save, delete, create)
- **Progress callbacks**: Only for progress updates, not completion toasts

**For useEffect**: Only include dependencies that should trigger re-runs:
- ‚úÖ **Include**: External props, primitive state, ref values
- ‚ùå **Exclude**: State variables modified inside the effect
- ‚ùå **Exclude**: Functions that change every render (`showToast`, service functions)

**For State Updates**: Use built-in React patterns:
- `useCallback` with stable dependencies only
- `useRef` for stable function references when needed
- Local variables inside effects instead of state dependencies

#### **Async Toggle Race Conditions**

**Root Cause**: Rapid clicks or state inconsistencies during async operations (like feature toggles).

```typescript
// ‚ùå PROBLEMATIC: No protection against rapid clicks or race conditions
const handleLogfireToggle = async (checked: boolean) => {
  setLogfireEnabled(checked); // Immediate state update
  
  await credentialsService.createCredential({
    key: 'LOGFIRE_ENABLED',
    value: checked.toString(),
    // ... config
  });
  
  showToast(
    checked ? 'Logfire Enabled Successfully!' : 'Logfire Now Disabled', 
    checked ? 'success' : 'warning'
  );
  // If user clicks rapidly, multiple toasts can fire with different values!
};

// ‚úÖ SOLUTION: Use loading state to prevent race conditions
const handleLogfireToggle = async (checked: boolean) => {
  if (loading) return; // Prevent duplicate calls while one is in progress
  
  try {
    setLoading(true);
    setLogfireEnabled(checked);
    
    await credentialsService.createCredential({
      key: 'LOGFIRE_ENABLED',
      value: checked.toString(),
      // ... config
    });
    
    showToast(
      checked ? 'Logfire Enabled Successfully!' : 'Logfire Now Disabled', 
      checked ? 'success' : 'warning'
    );
  } catch (error) {
    setLogfireEnabled(!checked); // Revert on error
    showToast('Failed to update Logfire setting', 'error');
  } finally {
    setLoading(false);
  }
};

// Disable toggle during loading:
<Toggle 
  checked={logfireEnabled} 
  onCheckedChange={handleLogfireToggle} 
  disabled={loading} // ‚úÖ Prevents interaction during async operation
/>
```

#### **Quick Debug Checklist**

When experiencing duplicate toasts or WebSocket issues:

1. **Check for multiple event sources**: Search codebase for the toast message
2. **Review useEffect dependencies**: Look for state variables modified inside the effect
3. **Verify single source of truth**: Ensure only one place shows each type of toast
4. **Check async race conditions**: Look for unprotected async toggle handlers
5. **Test systematically**: Use browser dev tools to trace event firing

